<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Primary Meta Tags -->
  <title>Setup - Premium Car</title>
  <meta name="title" content="Setup - Premium Car">
  <meta name="description" content="Configuracao inicial do Premium Car">
  <meta name="robots" content="noindex, nofollow">
  <meta name="googlebot" content="noindex, nofollow">

  <!-- Icons -->
  <link rel="icon" type="image/x-icon" href="/favicon.ico">
  <link rel="icon" type="image/svg+xml" href="/icons/favicon.svg">
  <link rel="icon" type="image/png" sizes="32x32" href="/icons/favicon-32x32.png">
  <meta name="theme-color" content="#dc3545">

  <!-- Bootstrap -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css">

  <!-- Design System -->
  <link rel="stylesheet" href="/css/design-tokens.css">
  <link rel="stylesheet" href="/css/global.css">
  <style>
    body {
      background: linear-gradient(135deg, #1a1a2e 0%, #16213e 50%, #0f3460 100%);
      min-height: 100vh;
      padding: 40px 20px;
    }

    .setup-container {
      max-width: 800px;
      margin: 0 auto;
    }

    .setup-header {
      text-align: center;
      margin-bottom: 40px;
      color: white;
    }

    .setup-header h1 {
      font-size: 2.5rem;
      font-weight: 700;
      margin-bottom: 10px;
    }

    .setup-header p {
      opacity: 0.8;
      font-size: 1.1rem;
    }

    .setup-card {
      background: white;
      border-radius: 20px;
      box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
      padding: 40px;
      margin-bottom: 30px;
    }

    .status-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
      gap: 15px;
      margin-bottom: 30px;
    }

    .status-item {
      padding: 20px;
      border-radius: 12px;
      text-align: center;
      background: #f8f9fa;
    }

    .status-item.success {
      background: #d1e7dd;
      color: #0a3622;
    }

    .status-item.error {
      background: #f8d7da;
      color: #58151c;
    }

    .status-item.pending {
      background: #fff3cd;
      color: #664d03;
    }

    .status-item i {
      font-size: 2rem;
      display: block;
      margin-bottom: 10px;
    }

    .step-section {
      border-bottom: 1px solid #e9ecef;
      padding-bottom: 30px;
      margin-bottom: 30px;
    }

    .step-section:last-child {
      border-bottom: none;
      margin-bottom: 0;
    }

    .step-number {
      width: 40px;
      height: 40px;
      background: #dc3545;
      color: white;
      border-radius: 50%;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      font-weight: bold;
      margin-right: 15px;
    }

    .step-number.completed {
      background: #198754;
    }

    .step-title {
      display: inline-flex;
      align-items: center;
      margin-bottom: 20px;
    }

    .step-title h3 {
      margin: 0;
      font-size: 1.3rem;
    }

    .form-floating {
      margin-bottom: 15px;
    }

    .form-floating input {
      border: 2px solid #e9ecef;
      border-radius: 12px;
    }

    .form-floating input:focus {
      border-color: #dc3545;
      box-shadow: 0 0 0 0.2rem rgba(220, 53, 69, 0.15);
    }

    .btn-action {
      padding: 12px 30px;
      font-weight: 600;
      border-radius: 12px;
      transition: all 0.3s ease;
    }

    .btn-action:hover {
      transform: translateY(-2px);
    }

    .sql-code {
      background: #1a1a2e;
      color: #00ff88;
      padding: 20px;
      border-radius: 12px;
      font-family: 'Monaco', 'Consolas', monospace;
      font-size: 0.85rem;
      overflow-x: auto;
      max-height: 300px;
      overflow-y: auto;
    }

    .copy-btn {
      position: absolute;
      top: 10px;
      right: 10px;
    }

    .info-box {
      background: #e7f5ff;
      border-left: 4px solid #0d6efd;
      padding: 15px 20px;
      border-radius: 0 12px 12px 0;
      margin-bottom: 20px;
    }

    .warning-box {
      background: #fff3cd;
      border-left: 4px solid #ffc107;
      padding: 15px 20px;
      border-radius: 0 12px 12px 0;
      margin-bottom: 20px;
    }

    .success-box {
      background: #d1e7dd;
      border-left: 4px solid #198754;
      padding: 15px 20px;
      border-radius: 0 12px 12px 0;
      margin-bottom: 20px;
    }

    @media (max-width: 576px) {
      .setup-card {
        padding: 25px 20px;
      }

      .setup-header h1 {
        font-size: 1.8rem;
      }
    }
  </style>
</head>
<body>
  <div class="setup-container">
    <div class="setup-header">
      <i class="bi bi-gear-fill" style="font-size: 3rem;"></i>
      <h1>Setup do Sistema</h1>
      <p>Configure o Premium Car em poucos passos</p>
    </div>

    <!-- Status do Sistema -->
    <div class="setup-card">
      <h2 class="mb-4"><i class="bi bi-speedometer2 me-2"></i>Status do Sistema</h2>
      <div id="statusLoading" class="text-center py-4">
        <div class="spinner-border text-primary" role="status">
          <span class="visually-hidden">Carregando...</span>
        </div>
        <p class="mt-2 text-muted">Verificando status...</p>
      </div>
      <div id="statusContent" style="display: none;">
        <div class="status-grid" id="statusGrid"></div>
        <div id="statusMessage"></div>
      </div>
    </div>

    <!-- Passo 1: Migracoes -->
    <div class="setup-card">
      <div class="step-section">
        <div class="step-title">
          <span class="step-number" id="step1Number">1</span>
          <h3>Executar Migracoes no Supabase</h3>
        </div>

        <div class="info-box">
          <i class="bi bi-info-circle me-2"></i>
          <strong>Importante:</strong> Copie o SQL abaixo e execute no Supabase SQL Editor.
          <br>
          <a href="https://supabase.com/dashboard" target="_blank" class="mt-2 d-inline-block">
            <i class="bi bi-box-arrow-up-right me-1"></i>Abrir Supabase Dashboard
          </a>
        </div>

        <div class="position-relative">
          <button class="btn btn-sm btn-outline-light copy-btn" onclick="copiarSQL()">
            <i class="bi bi-clipboard me-1"></i>Copiar
          </button>
          <pre class="sql-code" id="sqlCode">-- Carregando SQL...</pre>
        </div>

        <button class="btn btn-primary btn-action mt-3" onclick="verificarStatus()">
          <i class="bi bi-arrow-clockwise me-2"></i>Verificar Novamente
        </button>
      </div>
    </div>

    <!-- Passo 2: Criar Super Admin -->
    <div class="setup-card">
      <div class="step-section">
        <div class="step-title">
          <span class="step-number" id="step2Number">2</span>
          <h3>Criar Super Admin</h3>
        </div>

        <div id="superAdminExists" style="display: none;">
          <div class="success-box">
            <i class="bi bi-check-circle me-2"></i>
            <strong>Super Admin ja configurado!</strong> Voce pode fazer login normalmente.
          </div>
        </div>

        <form id="superAdminForm">
          <div class="row">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="adminName" placeholder="Nome" value="Super Admin">
                <label for="adminName">Nome completo</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="email" class="form-control" id="adminEmail" placeholder="email@exemplo.com" required>
                <label for="adminEmail">E-mail</label>
              </div>
            </div>
          </div>

          <div class="row">
            <div class="col-md-6">
              <div class="form-floating">
                <input type="password" class="form-control" id="adminPassword" placeholder="Senha" required minlength="8">
                <label for="adminPassword">Senha (min. 8 caracteres)</label>
              </div>
            </div>
            <div class="col-md-6">
              <div class="form-floating">
                <input type="text" class="form-control" id="setupKey" placeholder="Chave de setup" required value="premium-car-setup-2024">
                <label for="setupKey">Chave de Setup</label>
              </div>
            </div>
          </div>

          <div class="warning-box">
            <i class="bi bi-exclamation-triangle me-2"></i>
            <strong>Atencao:</strong> Guarde a senha em local seguro. O super admin tem acesso total ao sistema.
          </div>

          <button type="submit" class="btn btn-danger btn-action" id="btnCreateAdmin">
            <i class="bi bi-shield-check me-2"></i>
            <span id="btnAdminText">Criar Super Admin</span>
          </button>
        </form>

        <div id="adminMsg" class="mt-3"></div>
      </div>
    </div>

    <!-- Passo 3: Popular com dados de exemplo -->
    <div class="setup-card">
      <div class="step-section">
        <div class="step-title">
          <span class="step-number" id="step3Number">3</span>
          <h3>Popular com Dados de Exemplo (Opcional)</h3>
        </div>

        <p class="text-muted">
          Adicione alguns carros de exemplo para testar o sistema.
        </p>

        <div class="form-floating mb-3">
          <input type="text" class="form-control" id="seedKey" placeholder="Chave de setup" value="premium-car-setup-2024">
          <label for="seedKey">Chave de Setup</label>
        </div>

        <button class="btn btn-outline-primary btn-action" onclick="popularDados()" id="btnSeed">
          <i class="bi bi-database-add me-2"></i>
          <span id="btnSeedText">Adicionar Carros de Exemplo</span>
        </button>

        <div id="seedMsg" class="mt-3"></div>
      </div>
    </div>

    <!-- Acoes Finais -->
    <div class="setup-card text-center">
      <h3 class="mb-4">Pronto para comecar?</h3>
      <div class="d-flex flex-wrap justify-content-center gap-3">
        <a href="/login.html" class="btn btn-danger btn-action btn-lg">
          <i class="bi bi-box-arrow-in-right me-2"></i>Fazer Login
        </a>
        <a href="/" class="btn btn-outline-dark btn-action btn-lg">
          <i class="bi bi-house me-2"></i>Ir para o Site
        </a>
        <a href="/admin" class="btn btn-outline-danger btn-action btn-lg">
          <i class="bi bi-speedometer2 me-2"></i>Painel Admin
        </a>
      </div>
    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // SQL para migracoes
    const sqlMigrations = `-- ============================================
-- PREMIUM CAR - SCHEMA COMPLETO
-- Execute no Supabase SQL Editor
-- ============================================

-- 1. TABELA DE CARROS AVALIADOS
CREATE TABLE IF NOT EXISTS carros_avaliados (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  titulo TEXT NOT NULL,
  descricao TEXT NOT NULL,
  marca TEXT NOT NULL,
  modelo TEXT NOT NULL,
  ano INTEGER NOT NULL,
  preco_estimado NUMERIC NOT NULL,
  nota_geral INTEGER NOT NULL CHECK (nota_geral >= 1 AND nota_geral <= 10),
  video_url TEXT,
  imagem_url TEXT,
  autor_email TEXT,
  data_postagem TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

-- Indices
CREATE INDEX IF NOT EXISTS idx_carros_data ON carros_avaliados(data_postagem DESC);
CREATE INDEX IF NOT EXISTS idx_carros_marca ON carros_avaliados(marca);

-- RLS
ALTER TABLE carros_avaliados ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Leitura publica carros" ON carros_avaliados;
CREATE POLICY "Leitura publica carros" ON carros_avaliados FOR SELECT USING (true);

DROP POLICY IF EXISTS "Insercao autenticada carros" ON carros_avaliados;
CREATE POLICY "Insercao autenticada carros" ON carros_avaliados FOR INSERT WITH CHECK (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Atualizacao autenticada carros" ON carros_avaliados;
CREATE POLICY "Atualizacao autenticada carros" ON carros_avaliados FOR UPDATE USING (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Delecao autenticada carros" ON carros_avaliados;
CREATE POLICY "Delecao autenticada carros" ON carros_avaliados FOR DELETE USING (auth.role() = 'authenticated');

-- 2. TABELA DE PERFIS
CREATE TABLE IF NOT EXISTS user_profiles (
  id UUID PRIMARY KEY REFERENCES auth.users(id) ON DELETE CASCADE,
  email TEXT UNIQUE NOT NULL,
  full_name TEXT,
  role TEXT DEFAULT 'user' CHECK (role IN ('user', 'admin', 'super_admin')),
  avatar_url TEXT,
  is_active BOOLEAN DEFAULT true,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  updated_at TIMESTAMP WITH TIME ZONE DEFAULT NOW()
);

CREATE INDEX IF NOT EXISTS idx_user_profiles_email ON user_profiles(email);
CREATE INDEX IF NOT EXISTS idx_user_profiles_role ON user_profiles(role);

ALTER TABLE user_profiles ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Ver proprio perfil" ON user_profiles;
CREATE POLICY "Ver proprio perfil" ON user_profiles FOR SELECT USING (auth.uid() = id);

DROP POLICY IF EXISTS "Inserir perfil" ON user_profiles;
CREATE POLICY "Inserir perfil" ON user_profiles FOR INSERT WITH CHECK (true);

DROP POLICY IF EXISTS "Atualizar proprio perfil" ON user_profiles;
CREATE POLICY "Atualizar proprio perfil" ON user_profiles FOR UPDATE USING (auth.uid() = id);

-- 3. TABELA DE CONTATOS
CREATE TABLE IF NOT EXISTS contacts (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  name TEXT NOT NULL,
  email TEXT NOT NULL,
  phone TEXT,
  subject TEXT NOT NULL,
  message TEXT NOT NULL,
  created_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  read BOOLEAN DEFAULT FALSE
);

CREATE INDEX IF NOT EXISTS idx_contacts_created_at ON contacts(created_at DESC);
ALTER TABLE contacts ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Inserir contato publico" ON contacts;
CREATE POLICY "Inserir contato publico" ON contacts FOR INSERT WITH CHECK (true);

DROP POLICY IF EXISTS "Ler contatos autenticado" ON contacts;
CREATE POLICY "Ler contatos autenticado" ON contacts FOR SELECT USING (auth.role() = 'authenticated');

-- 4. TABELA DE NEWSLETTER
CREATE TABLE IF NOT EXISTS newsletter (
  id UUID DEFAULT gen_random_uuid() PRIMARY KEY,
  email TEXT UNIQUE NOT NULL,
  subscribed_at TIMESTAMP WITH TIME ZONE DEFAULT NOW(),
  is_active BOOLEAN DEFAULT TRUE,
  source TEXT DEFAULT 'website'
);

CREATE INDEX IF NOT EXISTS idx_newsletter_email ON newsletter(email);
ALTER TABLE newsletter ENABLE ROW LEVEL SECURITY;

DROP POLICY IF EXISTS "Inserir newsletter publico" ON newsletter;
CREATE POLICY "Inserir newsletter publico" ON newsletter FOR INSERT WITH CHECK (true);

DROP POLICY IF EXISTS "Ler newsletter autenticado" ON newsletter;
CREATE POLICY "Ler newsletter autenticado" ON newsletter FOR SELECT USING (auth.role() = 'authenticated');

DROP POLICY IF EXISTS "Deletar newsletter publico" ON newsletter;
CREATE POLICY "Deletar newsletter publico" ON newsletter FOR DELETE USING (true);

-- 5. TRIGGER PARA CRIAR PERFIL
CREATE OR REPLACE FUNCTION public.handle_new_user()
RETURNS TRIGGER AS $$
BEGIN
  INSERT INTO public.user_profiles (id, email, full_name, role)
  VALUES (
    NEW.id,
    NEW.email,
    COALESCE(NEW.raw_user_meta_data->>'full_name', ''),
    COALESCE(NEW.raw_user_meta_data->>'role', 'user')
  );
  RETURN NEW;
END;
$$ LANGUAGE plpgsql SECURITY DEFINER;

DROP TRIGGER IF EXISTS on_auth_user_created ON auth.users;
CREATE TRIGGER on_auth_user_created
  AFTER INSERT ON auth.users
  FOR EACH ROW EXECUTE FUNCTION public.handle_new_user();

-- FIM DO SCHEMA
`;

    document.getElementById('sqlCode').textContent = sqlMigrations;

    // Verificar status ao carregar
    verificarStatus();

    async function verificarStatus() {
      const loading = document.getElementById('statusLoading');
      const content = document.getElementById('statusContent');
      const grid = document.getElementById('statusGrid');
      const message = document.getElementById('statusMessage');

      loading.style.display = 'block';
      content.style.display = 'none';

      try {
        const response = await fetch('/api/setup/status');
        const data = await response.json();

        loading.style.display = 'none';
        content.style.display = 'block';

        // Mostrar status das tabelas
        let gridHTML = '';
        const tables = data.tables || {};

        const tableNames = {
          carros_avaliados: 'Carros',
          user_profiles: 'Perfis',
          contacts: 'Contatos',
          newsletter: 'Newsletter'
        };

        for (const [key, exists] of Object.entries(tables)) {
          gridHTML += `
            <div class="status-item ${exists ? 'success' : 'error'}">
              <i class="bi bi-${exists ? 'check-circle' : 'x-circle'}"></i>
              <strong>${tableNames[key] || key}</strong>
            </div>
          `;
        }

        // Super admin status
        gridHTML += `
          <div class="status-item ${data.superadmin ? 'success' : 'pending'}">
            <i class="bi bi-${data.superadmin ? 'shield-check' : 'shield-exclamation'}"></i>
            <strong>Super Admin</strong>
          </div>
        `;

        grid.innerHTML = gridHTML;

        // Mensagem de status
        if (data.ready) {
          message.innerHTML = `
            <div class="success-box">
              <i class="bi bi-check-circle me-2"></i>
              <strong>Sistema pronto!</strong> Todas as configuracoes estao completas.
            </div>
          `;
          document.getElementById('step1Number').classList.add('completed');
          document.getElementById('step2Number').classList.add('completed');
        } else if (!data.configured) {
          message.innerHTML = `
            <div class="warning-box">
              <i class="bi bi-exclamation-triangle me-2"></i>
              ${data.message}
            </div>
          `;
        } else {
          message.innerHTML = `
            <div class="info-box">
              <i class="bi bi-info-circle me-2"></i>
              ${data.message}
            </div>
          `;

          if (Object.values(tables).every(v => v)) {
            document.getElementById('step1Number').classList.add('completed');
          }
        }

        // Atualizar formulario de super admin
        if (data.superadmin) {
          document.getElementById('superAdminExists').style.display = 'block';
          document.getElementById('superAdminForm').style.display = 'none';
          document.getElementById('step2Number').classList.add('completed');
        }

      } catch (error) {
        loading.style.display = 'none';
        content.style.display = 'block';
        grid.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            Erro ao verificar status: ${error.message}
          </div>
        `;
      }
    }

    function copiarSQL() {
      navigator.clipboard.writeText(sqlMigrations).then(() => {
        const btn = document.querySelector('.copy-btn');
        btn.innerHTML = '<i class="bi bi-check me-1"></i>Copiado!';
        setTimeout(() => {
          btn.innerHTML = '<i class="bi bi-clipboard me-1"></i>Copiar';
        }, 2000);
      });
    }

    // Formulario de Super Admin
    document.getElementById('superAdminForm').addEventListener('submit', async (e) => {
      e.preventDefault();

      const btn = document.getElementById('btnCreateAdmin');
      const btnText = document.getElementById('btnAdminText');
      const msg = document.getElementById('adminMsg');

      const email = document.getElementById('adminEmail').value;
      const password = document.getElementById('adminPassword').value;
      const fullName = document.getElementById('adminName').value;
      const setupKey = document.getElementById('setupKey').value;

      if (password.length < 8) {
        msg.innerHTML = `
          <div class="alert alert-warning">
            <i class="bi bi-exclamation-triangle me-2"></i>
            A senha deve ter pelo menos 8 caracteres
          </div>
        `;
        return;
      }

      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Criando...';

      try {
        const response = await fetch('/api/setup/init', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            email,
            password,
            full_name: fullName,
            setup_key: setupKey
          })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error);
        }

        msg.innerHTML = `
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            ${data.message}
          </div>
        `;

        document.getElementById('step2Number').classList.add('completed');
        setTimeout(() => verificarStatus(), 1000);

      } catch (error) {
        msg.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${error.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Criar Super Admin';
      }
    });

    async function popularDados() {
      const btn = document.getElementById('btnSeed');
      const btnText = document.getElementById('btnSeedText');
      const msg = document.getElementById('seedMsg');
      const setupKey = document.getElementById('seedKey').value;

      btn.disabled = true;
      btnText.innerHTML = '<span class="spinner-border spinner-border-sm me-2"></span>Populando...';

      try {
        const response = await fetch('/api/setup/seed', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ setup_key: setupKey })
        });

        const data = await response.json();

        if (!response.ok) {
          throw new Error(data.error);
        }

        msg.innerHTML = `
          <div class="alert alert-success">
            <i class="bi bi-check-circle me-2"></i>
            ${data.message} Carros inseridos: ${data.inserted?.carros || 0}
          </div>
        `;

        document.getElementById('step3Number').classList.add('completed');

      } catch (error) {
        msg.innerHTML = `
          <div class="alert alert-danger">
            <i class="bi bi-exclamation-triangle me-2"></i>
            ${error.message}
          </div>
        `;
      } finally {
        btn.disabled = false;
        btnText.textContent = 'Adicionar Carros de Exemplo';
      }
    }
  </script>
</body>
</html>
